<!DOCTYPE html>
<html>
<head>
    <title>Chat App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/chat.css" />
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar for users -->
        <div class="col-md-3 bg-light border-end" id="user-list">
            <h5 class="mt-3">Online Users</h5>
            <ul id="users" class="list-unstyled"></ul>
        </div>
        <!-- Chat Section -->
        <div class="col-md-9">
            <div id="chat-container" class="p-3" style="height: 80vh; overflow-y: auto; background-color: #f9f9f9;">
                <!-- Chat messages will be dynamically appended here -->
            </div>
            <div class="input-group mt-3">
                <input id="chat-message" type="text" class="form-control" placeholder="Type your message..." />
                <button class="btn btn-primary" id="send-message">Send</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
<script>
    let stompClient;
    let username;
    let isMessageSending = false; // Prevent duplicate sends

    // Fetch the username from the server
    async function fetchUsername() {
        try {
            const response = await fetch('/api/auth/username', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
            });

            if (response.ok) {
                username = await response.text();
                connect(); // Connect to WebSocket
            } else {
                console.error('Failed to fetch username. Response:', response.status);
            }
        } catch (error) {
            console.error('Error fetching username:', error);
        }
    }

    // Fetch previous messages
    async function fetchMessages() {
        try {
            const response = await fetch('/api/messages', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
            });

            if (response.ok) {
                const messages = await response.json();
                const chatContainer = document.getElementById('chat-container');
                chatContainer.innerHTML = ''; // Clear any existing messages

                messages.forEach((message) => {
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message', 'mb-2');

                    if (message.type === 'JOIN' || message.type === 'LEAVE') {
                        messageElement.innerHTML = `<p class="text-muted"><em>${message.content}</em></p>`;
                    } else {
                        messageElement.innerHTML = `<p><strong>${message.sender}:</strong> ${message.content}</p>`;
                    }

                    chatContainer.appendChild(messageElement);
                });

                // Auto-scroll to the latest message
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } else {
                console.error('Failed to fetch messages. Status:', response.status);
            }
        } catch (error) {
            console.error('Error fetching messages:', error);
        }
    }

    // Initialize message fetch on page load
    document.addEventListener('DOMContentLoaded', () => {
        fetchMessages();
        fetchUsername(); // Ensure both username and messages are loaded
    });

    // Connect to WebSocket
    function connect() {
        const socket = new SockJS('/websocket');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, onConnected, (error) => {
            console.error('WebSocket connection failed:', error);
        });
    }

    function onConnected() {
        stompClient.subscribe('/topic/public', onMessageReceived);

        const joinMessage = {
            sender: username,
            content: `${username} joined!`,
            type: 'JOIN',
        };

        stompClient.send('/app/chat.send', {}, JSON.stringify(joinMessage));
    }


    // Send message
    function sendMessage() {
        const messageContent = document.getElementById('chat-message').value.trim();

        if (messageContent && stompClient) {
            const chatMessage = {
                sender: username,
                content: messageContent,
                type: 'CHAT',
            };

            stompClient.send('/app/chat.send', {}, JSON.stringify(chatMessage));
            document.getElementById('chat-message').value = ''; // Clear input
        }
    }

    function onMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        const chatContainer = document.getElementById('chat-container');
        const messageElement = document.createElement('div');

        if (message.type === 'JOIN' || message.type === 'LEAVE') {
            messageElement.innerHTML = `<p class="text-muted"><em>${message.content}</em></p>`;
        } else {
            messageElement.innerHTML = `<p><strong>${message.sender}:</strong> ${message.content}</p>`;
        }

        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight; // Auto-scroll
    }

    // Attach send button functionality
    document.getElementById('send-message').addEventListener('click', sendMessage);

    // Enable sending message with Enter key
    document.getElementById('chat-message').addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // Prevent newline in input
            sendMessage();
        }
    });
</script>
</body>
</html>
