<!DOCTYPE html>
<html>
<head>
    <title>Chat App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/chat.css" />
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar for users -->
        <div class="col-md-3 bg-light border-end" id="user-list">
            <h5 class="mt-3">Online Users</h5>
            <ul id="users" class="list-unstyled"></ul>
        </div>
        <!-- Chat Section -->
        <div class="col-md-9">
            <div id="chat-container" class="p-3" style="height: 80vh; overflow-y: auto; background-color: #f9f9f9;">
                <!-- Chat messages will be dynamically appended here -->
            </div>
            <div class="input-group mt-3">
                <input id="chat-message" type="text" class="form-control" placeholder="Type your message..." />
                <button class="btn btn-primary" id="send-message">Send</button>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
<script>
    let stompClient;
    let username = prompt("Enter your username:");

    function connect() {
        let socket = new SockJS('/websocket');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, onConnected, onError);
    }

    function onConnected() {
        // Subscribe to the public topic
        stompClient.subscribe('/topic/public', onMessageReceived);
        // Notify that a user has joined
        stompClient.send("/app/chat.send", {}, JSON.stringify({
            sender: username,
            content: username + ' joined!',
            type: 'JOIN'
        }));
    }

    function onError(error) {
        console.error("Could not connect to WebSocket server.", error);
    }

    function sendMessage() {
        const messageContent = document.getElementById('chat-message').value.trim();
        if (messageContent && stompClient) {
            const chatMessage = {
                sender: username,
                content: messageContent,
                type: 'CHAT'
            };
            stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
            document.getElementById('chat-message').value = '';
        }
    }

    function onMessageReceived(payload) {
        const message = JSON.parse(payload.body);
        const chatContainer = document.getElementById('chat-container');
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', 'mb-2');

        if (message.type === 'JOIN' || message.type === 'LEAVE') {
            messageElement.innerHTML = `<p class="text-muted"><em>${message.content}</em></p>`;
        } else {
            messageElement.innerHTML = `<p><strong>${message.sender}:</strong> ${message.content}</p>`;
        }

        chatContainer.appendChild(messageElement);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    document.getElementById('send-message').addEventListener('click', sendMessage);
    connect();
    function sendMessage() {
        const messageContent = document.getElementById('chat-message').value.trim();
        const receiver = "public"; // Change to private chat username if implementing private chat

        if (messageContent && stompClient) {
            const chatMessage = {
                sender: username,
                receiver: receiver, // Add receiver
                content: messageContent,
                type: 'CHAT'
            };
            stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
            document.getElementById('chat-message').value = '';
        }
    }
    async function loadPreviousMessages() {
        try {
            const response = await fetch('/api/messages', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const messages = await response.json();

            const chatContainer = document.getElementById('chat-container');
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', 'mb-2');
                messageElement.innerHTML = `<p><strong>${message.sender}:</strong> ${message.content}</p>`;
                chatContainer.appendChild(messageElement);
            });

            chatContainer.scrollTop = chatContainer.scrollHeight;
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadPreviousMessages();
    });

</script>
</body>
</html>
